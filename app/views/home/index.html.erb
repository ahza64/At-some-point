<% if current_user %>
<div class="container">
  <div class="row">
    <div class="col-xs-12 col-md-8">
      <div class="map_container">
        <div id="map" class="map"></div>
      </div>
    </div>
    <div class="col-xs-12 col-md-4">
      <div id="right-panel" class="panel panel-default">
        <div class="panel-body">
          <b>Start:</b>
          <select id="start" class="form-control">
            <% @tasks.each do |task|  %>
            <option value="<%= task.location%>"> <%= task.name %></option>
            <% end %>
          </select>

          <b>Waypoints:</b>
          <i>(Ctrl-Click for multiple selection)</i> <br>
          <select multiple id="waypoints" class="form-control">
            <% @tasks.each do |task|  %>
            <option value="<%= task.location%>"> <%= task.name %></option>
            <% end %>
          </select>
          <br>
          <b>End:</b>
          <select id="end" class="form-control">
            <% @tasks.each do |task|  %>
            <option value="<%= task.location%>"> <%= task.name %></option>
            <% end %>
          </select>
        </div>
        <div class="panel-footer">
          <button type="submit" id="submit" class="btn btn-success btn-block">Let's Go</button>
        </div>
      </div>
      <div id="directions-panel" class="well well-lg"></div>
    </div>


  </div>
</div>

  <script>
    function initMap() {
      var directionsService = new google.maps.DirectionsService;
      var directionsDisplay = new google.maps.DirectionsRenderer;
      var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 6,
        center: {lat: 37.7749, lng: -122.4194}
      });
      directionsDisplay.setMap(map);

      document.getElementById('submit').addEventListener('click', function() {
        calculateAndDisplayRoute(directionsService, directionsDisplay);
      });
    }

    function calculateAndDisplayRoute(directionsService, directionsDisplay) {
      var waypts = [];
      var checkboxArray = document.getElementById('waypoints');
      for (var i = 0; i < checkboxArray.length; i++) {
        if (checkboxArray.options[i].selected) {
          waypts.push({
            location: checkboxArray[i].value,
            stopover: true
          });
        }
      }

      directionsService.route({
        origin: document.getElementById('start').value,
        destination: document.getElementById('end').value,
        waypoints: waypts,
        optimizeWaypoints: true,
        travelMode: google.maps.TravelMode.DRIVING
      }, function(response, status) {
        if (status === google.maps.DirectionsStatus.OK) {
          directionsDisplay.setDirections(response);
          var route = response.routes[0];
          var summaryPanel = document.getElementById('directions-panel');
          summaryPanel.innerHTML = '';
          // For each route, display summary information.
          for (var i = 0; i < route.legs.length; i++) {
            var routeSegment = i + 1;
            summaryPanel.innerHTML += '<b>Route Segment: ' + routeSegment +
                '</b><br>';
            summaryPanel.innerHTML += route.legs[i].start_address + ' to ';
            summaryPanel.innerHTML += route.legs[i].end_address + '<br>';
            summaryPanel.innerHTML += route.legs[i].distance.text + '<br><br>';
          }
        } else {
          window.alert('Directions request failed due to ' + status);
        }
      });
    }
  </script>
  <script async defer

      src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['secret_google_key'] %>&callback=initMap">
  </script>

<% else %>

<div class="container front-page">
  <div class="row">
    <div class=" col-lg-8 col-lg-offset-2 col-md-6 col-md-offset-3">
      <img class="featurette-image img-responsive center-block logo" src="http://the1perspective.com/jonatron/cargif.gif" alt="Generic placeholder image">
    </div>
  </div>
  <div class="row">
    <div class="class-md-10">
      <h2 class="featurette-heading">@ Some Point</h2>
      <p class="lead">Welcome to @SomePoint, helping you figure out your shortest path. Use the "sample log in user" above, or create your own user below to get started. Add tasks and click "Go". You will be able to pick a start and stop point, and any other stops you would like to make.</p>
    </div>
  </div>
    <%= link_to "Sign Up Today!", new_user_path, class: "btn btn-success" %>
</div>



<% end %>
